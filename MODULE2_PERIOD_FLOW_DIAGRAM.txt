╔════════════════════════════════════════════════════════════════════════════════╗
║                  MODULE 2: PERIOD ENVIRONMENT VARIABLE FLOW                     ║
║                        (After Critical Fix)                                     ║
╚════════════════════════════════════════════════════════════════════════════════╝


PIPELINE ARCHITECTURE:
═══════════════════════════════════════════════════════════════════════════════════

                    ┌─────────────────────────────────────────┐
                    │  Job 02: Prepare Artificial Data (once)  │
                    │  Creates ground_truth_metadata.json      │
                    │  and artificial_ground_truth_data.csv    │
                    └──────────────┬──────────────────────────┘
                                   │
                                   ↓
                    ┌──────────────────────────────────────────┐
                    │ Period 0 Monitoring Cycle                 │
                    └──────────────┬───────────────────────────┘
                                   │
        ┌──────────────────────────┼──────────────────────────┐
        ↓                          ↓                          ↓
   ╔═════════╗           ╔═════════════════╗        ╔═══════════════╗
   ║Job 3.1  ║           ║   Job 3.2       ║        ║  Job 3.3      ║
   ║         ║  passes   ║                 ║ passes ║               ║
   ║ Get     ├──PERIOD 0─┤ Load Ground     ├─PERIOD ┤ Check Model   ║
   ║Predict- ║  (via env ║ Truth           │ 0 (via │               ║
   ║ions     │variables) │                 │env var)│ Decision:     ║
   ║         ║           │                 ║        │ Continue?     ║
   ╚════┬════╝           ╚╤════════════════╝        ╚═════┬═════════╝
        │                 │                               │
        │ Output:         │ Output:                       │
        │ prediction_     │ current_period_               │ Output:
        │ period_0.json   │ ground_truth.json             │ check_model_
        │                 │                               │ results.json
        │                 │                               │
        │ Triggers next   │ Triggers next    Triggers next│
        │ via explicit    │ via explicit      via explicit│
        │ environment_    │ environment_      environment_│
        │ variables:      │ variables:        variables:  │
        │ PERIOD=0        │ PERIOD=0          PERIOD=1!!!│
        └─────────────────┴──────────────────┴───────────┘
                          │
                          ↓
                ┌──────────────────────────────────────────┐
                │ Period 1 Monitoring Cycle                 │
                └──────────────┬───────────────────────────┘
                               │
            ┌──────────────────┼──────────────────────┐
            ↓                  ↓                      ↓
       ╔═════════╗    ╔═════════════════╗   ╔═══════════════╗
       ║Job 3.1  ║    ║   Job 3.2       ║   ║  Job 3.3      ║
       ║         ║    ║                 ║   ║               ║
       ║ Get     ├─PERIOD 1──┤ Load Ground├─PERIOD 1──┤ Check Model   ║
       ║Predict- │           │ Truth      │   (via env│               ║
       ║ions     │           │            │ variables)│ Decision:     ║
       ║         │           │            │           │ Degraded?     ║
       ╚════┬════╝           ╚╤═══════════╝           ╚═════┬═════════╝
            │                 │                             │
            │                 │                             ├─→ YES: EXIT (degradation alert)
            │                 │                             ├─→ NO, last period: EXIT (success)
            │                 │                             └─→ NO, continue: Trigger Period 2
            └─────────────────┴─────────────────────────────┘
                              │
                   (Cycles continue...)
                              │
                              ↓
                    ┌──────────────────────────────────────────┐
                    │ Final Decision: Pipeline Termination      │
                    │ • Degradation detected → Alert & Exit     │
                    │ • Last period reached → Success & Exit    │
                    └──────────────────────────────────────────┘


CRITICAL FLOW: HOW PERIOD IS PASSED
═══════════════════════════════════════════════════════════════════════════════════

Job 3.1 → Job 3.2 → Job 3.3 → (back to Job 3.1)
  │         │         │
  ├─────────┘         │
  │ CRITICAL FIX:     │
  │ Passes PERIOD=0   │
  │ (SAME PERIOD)     │
  │                   │
  │                   ├──────────┘
  │                   │ CRITICAL FIX:
  │                   │ Passes PERIOD=0
  │                   │ (SAME PERIOD)
  │                   │
  │                   │ ORCHESTRATION:
  │                   │ Passes PERIOD=1
  │                   │ (INCREMENTED!)
  │
  └───────────────────────────────────────────────────
                        │
                        ↓
                   Job 3.1 with
                   PERIOD=1


THE THREE PATTERNS:
═══════════════════════════════════════════════════════════════════════════════════

1. JOB 3.1 → JOB 3.2 (Horizontal transition)
   ┌─────────────────────────────────────────┐
   │ Job 3.1: Get Predictions (Period N)      │
   │   ↓                                      │
   │   Creates: predictions_period_N.json    │
   │   ↓                                      │
   │   TRIGGERS Job 3.2 with:                │
   │   environment_variables={               │
   │     "PERIOD": str(PERIOD)  ← SAME PERIOD│
   │   }                                      │
   │   ↓                                      │
   │ Job 3.2: Load Ground Truth (Period N)    │
   └─────────────────────────────────────────┘


2. JOB 3.2 → JOB 3.3 (Horizontal transition)
   ┌─────────────────────────────────────────┐
   │ Job 3.2: Load Ground Truth (Period N)    │
   │   ↓                                      │
   │   Creates: current_period_GT.json       │
   │   ↓                                      │
   │   TRIGGERS Job 3.3 with:                │
   │   environment_variables={               │
   │     "PERIOD": str(PERIOD)  ← SAME PERIOD│
   │   }                                      │
   │   ↓                                      │
   │ Job 3.3: Check Model (Period N)          │
   └─────────────────────────────────────────┘


3. JOB 3.3 → JOB 3.1 (Vertical transition - ORCHESTRATION)
   ┌─────────────────────────────────────────┐
   │ Job 3.3: Check Model (Period N)          │
   │   ↓                                      │
   │   Decision: Continue to next period      │
   │   ↓                                      │
   │   next_period = PERIOD + 1   ← INCREMENT!│
   │   ↓                                      │
   │   TRIGGERS Job 3.1 with:                │
   │   environment_variables={               │
   │     "PERIOD": str(next_period) ← PERIOD │
   │   }                           + 1        │
   │   ↓                                      │
   │ Job 3.1: Get Predictions (Period N+1)    │
   └─────────────────────────────────────────┘


WHY THIS FIX IS CRITICAL:
═══════════════════════════════════════════════════════════════════════════════════

BEFORE THE FIX:
───────────────
Job 3.1 (Period 0):
  ├─ Triggers Job 3.2
  └─ WITHOUT explicit environment_variables → Job 3.2 defaults to PERIOD=0 ✓ (luck!)

Job 3.2 (Period ???):
  ├─ Defaults to PERIOD=0 (from environment default)
  ├─ Creates labels for period 0
  ├─ Triggers Job 3.3
  └─ WITHOUT explicit environment_variables → Job 3.3 gets PERIOD=0 ✓ (luck!)

Job 3.3 (Period ???):
  ├─ Defaults to PERIOD=0 (from environment default)
  ├─ Validates accuracy against period 0
  ├─ Decides: continue to period 1
  └─ Triggers Job 3.1 with PERIOD=1 ✓ (this one was correct!)

Job 3.1 (Period 1):
  ├─ Receives PERIOD=1 ✓
  ├─ Triggers Job 3.2
  └─ WITHOUT explicit environment_variables → Job 3.2 defaults to PERIOD=0 ✗ WRONG!

Job 3.2 (Period 0 ???):
  ├─ Defaults to PERIOD=0 (from environment default)
  ├─ Loads labels for period 0 (WRONG!)
  ├─ But Job 3.1 just ran period 1 (DATA MISMATCH!)
  └─ Pipeline behavior becomes unpredictable...


AFTER THE FIX:
──────────────
Job 3.1 (Period 0):
  ├─ Triggers Job 3.2
  └─ WITH explicit environment_variables={"PERIOD": "0"} → Job 3.2 gets PERIOD=0 ✓

Job 3.2 (Period 0):
  ├─ Receives PERIOD=0 (explicitly passed)
  ├─ Creates labels for period 0
  ├─ Triggers Job 3.3
  └─ WITH explicit environment_variables={"PERIOD": "0"} → Job 3.3 gets PERIOD=0 ✓

Job 3.3 (Period 0):
  ├─ Receives PERIOD=0 (explicitly passed)
  ├─ Validates accuracy against period 0
  ├─ Decides: continue to period 1
  └─ Triggers Job 3.1 with environment_variables={"PERIOD": "1"} ✓

Job 3.1 (Period 1):
  ├─ Receives PERIOD=1 (explicitly passed)
  ├─ Triggers Job 3.2
  └─ WITH explicit environment_variables={"PERIOD": "1"} → Job 3.2 gets PERIOD=1 ✓

Job 3.2 (Period 1):
  ├─ Receives PERIOD=1 (explicitly passed)
  ├─ Creates labels for period 1
  ├─ Triggers Job 3.3
  └─ WITH explicit environment_variables={"PERIOD": "1"} → Job 3.3 gets PERIOD=1 ✓

Job 3.3 (Period 1):
  ├─ Receives PERIOD=1 (explicitly passed)
  ├─ Validates accuracy against period 1 ✓ DATA ALIGNED!
  └─ Continues or exits cleanly

(Pipeline progresses reliably through all periods)


KEY TAKEAWAY:
═══════════════════════════════════════════════════════════════════════════════════

CML DOES NOT INHERIT ENVIRONMENT VARIABLES BETWEEN JOBS!

If you don't explicitly pass them via job_run_request.environment_variables,
the triggered job will use its default values (from the job definition or
os.environ.get() with defaults).

This fix ensures deterministic, predictable pipeline behavior by making
environment variable passing EXPLICIT at every step.

═══════════════════════════════════════════════════════════════════════════════════
